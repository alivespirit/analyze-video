<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logs for {{ day }}</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header id="page-top">
    <h1>Logs for {{ day }}</h1>
    <nav><a href="/">← Back</a></nav>
  </header>

  <main>
    <!-- Floating action buttons (mobile): jump to end / top -->
    <a href="#page-bottom" class="fab" aria-label="Jump to end">↓</a>
    <a href="#page-top" class="fab-top" aria-label="Back to top">↑</a>
    <section class="controls">
      <form method="get" class="filters">
        <label>Severity:
          <select name="severity">
            <option value="" {% if not severity %}selected{% endif %}>All</option>
            {% for lvl in levels %}
            <option value="{{ lvl }}" {% if severity==lvl %}selected{% endif %}>{{ lvl }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Status:
          <select name="status">
            <option value="" {% if not status %}selected{% endif %}>All</option>
            {% for s in statuses %}
            <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit">Apply</button>
      </form>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Status Counts</h2>
        {% if severity or status %}
          <p class="muted">Filtered videos: <strong>{{ metrics.videos_total }}</strong> (Total today: <strong>{{ total_videos_all }}</strong>)</p>
        {% else %}
          <p class="muted">Total videos: <strong>{{ total_videos_all }}</strong></p>
        {% endif %}
        {% if metrics.status_counts %}
          <ul class="stats">
            {% for k,v in metrics.status_counts.items() %}
              {% set col = status_colors.get(k, '#3b82f6') %}
              {% set tcol = status_text_colors.get(k, '#ffffff') %}
              <li><span class="tag" style="background: {{ col }}; color: {{ tcol }}">{{ k }}</span> <strong>{{ v }}</strong></li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No status entries.</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>Gate Crossings</h2>
        <ul class="stats">
          <li><span class="tag">up</span> <strong>{{ metrics.gate_counts.up }}</strong></li>
          <li><span class="tag">down</span> <strong>{{ metrics.gate_counts.down }}</strong></li>
        </ul>
      </div>

      <div class="card">
        <h2>Full Processing Time</h2>
        {% if metrics.full_processing_stats %}
          <ul class="stats">
            <li>min: <strong>{{ '%.2f'|format(metrics.full_processing_stats.min) }}s</strong></li>
            <li>avg: <strong>{{ '%.2f'|format(metrics.full_processing_stats.avg) }}s</strong></li>
            <li>max: <strong>{{ '%.2f'|format(metrics.full_processing_stats.max) }}s</strong></li>
          </ul>
        {% else %}
          <p>No full processing timings.</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>Motion Detection Time</h2>
        {% if metrics.motion_detection_stats %}
          <ul class="stats">
            <li>min: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.min) }}s</strong></li>
            <li>avg: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.avg) }}s</strong></li>
            <li>max: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.max) }}s</strong></li>
          </ul>
        {% else %}
          <p>No motion detection timing entries.</p>
        {% endif %}
      </div>
    </section>

    <details class="card">
      <summary>Per-Video Summary</summary>
      {% if metrics.status_per_video %}
        <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Start</th>
              <th>Video</th>
              <th>Status</th>
              <th>Raw Events</th>
              <th>Processing Time</th>
            </tr>
          </thead>
          <tbody>
            {% for vid, status in metrics.status_per_video.items() %}
            <tr>
              <td>
                {% set t = metrics.first_seen_ts_per_video.get(vid) %}
                {% if t %}
                  {{ t.strftime('%H:%M:%S') }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td><a href="#log-{{ vid }}" class="link-log">{{ vid }}</a></td>
              {% set col = status_colors.get(status, '#3b82f6') %}
              {% set tcol = status_text_colors.get(status, '#ffffff') %}
              <td><span class="tag status-chip" style="background: {{ col }}; color: {{ tcol }}" aria-label="{{ status }}" title="{{ status }}">{{ status }}</span></td>
              <td>{{ metrics.raw_events_per_video.get(vid, 0) }}</td>
              <td>
                {% set p = metrics.processing_time_per_video.get(vid) %}
                {% if p %}
                  {{ '%.2f'|format(p) }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <p>No video summaries.</p>
      {% endif %}
    </details>

    <section class="card">
      <h2>Processing Times Chart</h2>
      {% if chart_pairs and chart_pairs|length > 0 %}
        {% set pairs = chart_pairs %}
        {% set values = pairs|map(attribute=1)|list %}
        {% set maxv = (values|max) %}
        {% set minv = (values|min) %}
        {% set avgv = (values|sum / values|length) %}
        {% set n = pairs|length %}
        <!-- Normalize to a fixed viewBox and space bars across full width -->
        {% set vbw = 1000 %}
        {% set vbh = 240 %}
        {% set left = 60 %}
        {% set right = 20 %}
        {% set topPad = 2 %}
        {% set bottomPad = 6 %}
        {% set yTop = topPad %}
        {% set yBottom = vbh - bottomPad %}
        {% set plotH = yBottom - yTop %}
        {% set axisW = vbw - left - right %}
        {% set step = axisW / n %}
        {% set barW = (step * 0.6) if step * 0.6 < 40 else 40 %}
        {% set denom = maxv if maxv > 0 else 1 %}
        {% set y_max = yBottom - (maxv / denom) * plotH %}
        {% set y_avg = yBottom - (avgv / denom) * plotH %}
        {% set y_min = yBottom - (minv / denom) * plotH %}
        <div class="chart-wrap">
          <svg class="chart" width="100%" height="260" viewBox="0 0 {{ vbw }} {{ vbh }}" preserveAspectRatio="xMinYMin meet">
            <!-- Axis -->
            <line x1="{{ left }}" y1="{{ yBottom }}" x2="{{ vbw - right }}" y2="{{ yBottom }}" stroke="#444" />
            <line x1="{{ left }}" y1="{{ yTop }}" x2="{{ left }}" y2="{{ yBottom }}" stroke="#444" />
            <!-- Grid lines for max/avg/min -->
            <line x1="{{ left }}" y1="{{ y_max }}" x2="{{ vbw - right }}" y2="{{ y_max }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_avg }}" x2="{{ vbw - right }}" y2="{{ y_avg }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_min }}" x2="{{ vbw - right }}" y2="{{ y_min }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <!-- Bars evenly spaced across full width -->
            {% for i in range(n) %}
              {% set vid = pairs[i][0] %}
              {% set val = pairs[i][1] %}
              {% set st = metrics.status_per_video.get(vid, 'unknown') %}
              {% set col = status_colors.get(st, '#3b82f6') %}
              {% set x = left + i * step + (step - barW) / 2 %}
              {% set h = (val / denom) * plotH %}
              {% set y = yBottom - h %}
              <a href="#log-{{ vid }}">
                <rect x="{{ x }}" y="{{ y }}" width="{{ barW }}" height="{{ h }}" fill="{{ col }}">
                  <title>{{ vid }} ({{ '%.2f'|format(val) }}s)</title>
                </rect>
              </a>
              <line x1="{{ left + i * step + step / 2 }}" y1="{{ yBottom }}" x2="{{ left + i * step + step / 2 }}" y2="{{ yBottom + 4 }}" stroke="#444" />
            {% endfor %}
            <!-- Y labels (right-aligned to the Y axis, numeric only) -->
            <text class="axis-label" x="{{ left - 8 }}" y="{{ yBottom }}" text-anchor="end" fill="#a8adc0">0</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_max + 12 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(maxv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_avg + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(avgv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_min + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(minv) }}</text>
          </svg>
        </div>
        {% if statuses_present and statuses_present|length > 0 %}
        <div class="chart-legend">
          <ul>
            {% for s in statuses_present %}
              {% set col = status_colors.get(s, '#3b82f6') %}
              <li class="legend-item"><span class="legend-chip" style="background: {{ col }}"></span> {{ s }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      {% else %}
        <p>No processing time data.</p>
      {% endif %}
    </section>

    <section class="card">
      <h2>Log Entries{% if severity %} ({{ severity }}){% endif %}</h2>
      {% if entries %}
        {% set ns = namespace(seen={}) %}
        <ul class="logs">
          {% for e in entries %}
          <li class="log {{ e.level|lower }}"{% if e.video and not ns.seen.get(e.video) %} id="log-{{ e.video }}"{% set _ = ns.seen.update({e.video: True}) %}{% endif %}>
            <div class="meta">
              <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
              <span class="lvl">{{ e.level }}</span>
              {% if e.video %}
                {% set vc = video_colors.get(e.video, '#9fb0ff') %}
                {% set parts = e.video.split('.') %}
                {% set base = parts[:-1] | join('.') %}
                <span class="video video-inline" style="color: {{ vc }}">{{ base }}</span>
              {% endif %}
            </div>
            <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
            <span class="lvl">{{ e.level }}</span>
            {% if e.video %}
              {% set vc = video_colors.get(e.video, '#9fb0ff') %}
              <div class="video" style="color: {{ vc }}">{{ e.video }}</div>
            {% else %}
              <div class="video none">—</div>
            {% endif %}
            <div class="msg">{{ e.content }}</div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No entries for this day and filter.</p>
      {% endif %}
    </section>
  </main>
  <!-- Target anchor for jump-to-end -->
  <div id="page-bottom"></div>
</body>
</html>