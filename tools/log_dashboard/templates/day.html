<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logs for {{ day }}</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header id="page-top">
    <div class="inner">
      <h1>{{ day }}</h1>
      <nav>
        <a class="nav-btn" href="{% if is_today_route %}/today{% else %}/day/{{ day }}{% endif %}" title="Home">Home</a>
        <a class="nav-btn" href="/" title="All Days">All Days</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- Floating action buttons (mobile): jump to end / top -->
    <a href="#page-bottom" class="fab hidden" aria-label="Jump to end">↓</a>
    <a href="#page-top" class="fab-top hidden" aria-label="Back to top">↑</a>
    {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
    <section class="controls">
      <div class="filters">
        <span class="muted">Severity:</span>
        <div class="badge-row">
          {% for lvl in levels %}
            {% set scol = severity_colors.get(lvl, '#3b82f6') %}
            {% set stcol = severity_text_colors.get(lvl, '#ffffff') %}
            {% set status_csv = status_list|join(',') if status_list and (status_list|length > 0) else '' %}
            <a class="link-log" href="{% if severity == lvl %}{{ base }}{% if status_csv or video %}?{% endif %}{% if status_csv %}status={{ status_csv }}{% endif %}{% if video %}{% if status_csv %}&{% endif %}video={{ video }}{% endif %}{% else %}{{ base }}?severity={{ lvl }}{% if status_csv %}&status={{ status_csv }}{% endif %}{% if video %}&video={{ video }}{% endif %}{% endif %}" title="{% if severity == lvl %}Clear severity filter{% else %}Filter by {{ lvl }}{% endif %}">
              <span class="tag {% if severity == lvl %}active{% endif %}" style="background: {{ scol }}; color: {{ stcol }}">{{ lvl }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div class="split-card">
          <div class="left">
            <h2>Status Counts</h2>
            {% set status_list = status_list or [] %}
            {% set has_status = status_list and (status_list|length > 0) %}
            {% if severity or has_status or gate or video %}
              <p class="muted">
                Filtered videos: <strong>{{ metrics.videos_total }}</strong>
                (Total today: <strong>{{ total_videos_all }}</strong>)
                {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
                <a class="link-log" href="{{ base }}" title="Clear all filters">
                  <span class="tag">Clear</span>
                </a>
              </p>
            {% else %}
              <p class="muted">Total videos: <strong>{{ total_videos_all }}</strong></p>
            {% endif %}
            {% if statuses and statuses|length > 0 %}
              {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
              <ul class="stats status-badges">
                {% for k in statuses %}
                  {% set v = status_counts_all.get(k, 0) %}
                  {% set col = status_colors.get(k, '#3b82f6') %}
                  {% set tcol = status_text_colors.get(k, '#ffffff') %}
                  <li>
                    {% set active = has_status and (k in status_list) %}
                    {% set qs = '' %}
                    {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
                    {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
                    {% if video %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'video=' ~ video %}{% endif %}
                    {% set new_list = [] %}
                    {% if active %}
                      {% for s in status_list %}{% if s != k %}{% set _ = new_list.append(s) %}{% endif %}{% endfor %}
                    {% else %}
                      {% for s in status_list %}{% set _ = new_list.append(s) %}{% endfor %}
                      {% set _ = new_list.append(k) %}
                    {% endif %}
                    {% if new_list and (new_list|length > 0) %}
                      {% set status_csv = new_list|join(',') %}
                      {% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}
                    {% endif %}
                    <a class="link-log" href="{{ base }}{% if qs %}?{{ qs }}{% endif %}" title="{% if active %}Remove {{ k }}{% else %}Add {{ k }} filter{% endif %}">
                      <span class="tag {% if active %}active{% endif %}" style="background: {{ col }}; color: {{ tcol }}">{{ k }}</span>
                    </a>
                    <strong>{{ v }}</strong>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p>No status entries.</p>
            {% endif %}
          </div>
          <div class="right">
            <h2>Gate Crossings</h2>
            {% set status_csv = status_list|join(',') if status_list and (status_list|length > 0) else '' %}
            <ul class="stats">
              <li>
                <a class="link-log" href="{% if gate == 'up' %}{{ base }}{% if severity or status_csv or video %}?{% endif %}{% if severity %}severity={{ severity }}{% endif %}{% if status_csv %}{% if severity %}&{% endif %}status={{ status_csv }}{% endif %}{% if video %}{% if severity or status_csv %}&{% endif %}video={{ video }}{% endif %}{% else %}{{ base }}?gate=up{% if severity %}&severity={{ severity }}{% endif %}{% if status_csv %}&status={{ status_csv }}{% endif %}{% if video %}&video={{ video }}{% endif %}{% endif %}" title="{% if gate == 'up' %}Clear gate filter{% else %}Filter by gate: up{% endif %}">
                  <span class="tag {% if gate == 'up' %}active{% endif %}">up</span>
                </a>
                <strong>{{ metrics.gate_counts.up }}</strong>
              </li>
              <li>
                <a class="link-log" href="{% if gate == 'down' %}{{ base }}{% if severity or status_csv or video %}?{% endif %}{% if severity %}severity={{ severity }}{% endif %}{% if status_csv %}{% if severity %}&{% endif %}status={{ status_csv }}{% endif %}{% if video %}{% if severity or status_csv %}&{% endif %}video={{ video }}{% endif %}{% else %}{{ base }}?gate=down{% if severity %}&severity={{ severity }}{% endif %}{% if status_csv %}&status={{ status_csv }}{% endif %}{% if video %}&video={{ video }}{% endif %}{% endif %}" title="{% if gate == 'down' %}Clear gate filter{% else %}Filter by gate: down{% endif %}">
                  <span class="tag {% if gate == 'down' %}active{% endif %}">down</span>
                </a>
                <strong>{{ metrics.gate_counts.down }}</strong>
              </li>
            </ul>
            {% if away_intervals and away_intervals|length > 0 %}
              <div class="away-list">
                <h3 class="subheading">Events</h3>
                <ul class="stats">
                  {% for it in away_intervals %}
                    <li>
                      <span class="tag away-chip" style="background: #64748b; color: #ffffff">{{ it.start if it.start else '...' }}-{{ it.end if it.end else '...' }}{% if it.dur %} ({{ it.dur }}){% endif %}</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table times-table">
            <thead>
              <tr>
                <th></th>
                <th>
                  <span class="column-title label-desktop">Motion Detection</span>
                  <span class="column-title label-mobile">MD Time</span>
                </th>
                <th>
                  <span class="column-title label-desktop">Full Processing</span>
                  <span class="column-title label-mobile">FP Time</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>min</td>
                <td>{% if metrics.motion_detection_stats %}<span class="sec">{{ '%.2f'|format(metrics.motion_detection_stats.min) }}s</span>{% else %}—{% endif %}</td>
                <td>{% if metrics.full_processing_stats %}<span class="sec">{{ '%.2f'|format(metrics.full_processing_stats.min) }}s</span>{% else %}—{% endif %}</td>
              </tr>
              <tr>
                <td>avg</td>
                <td>{% if metrics.motion_detection_stats %}<span class="sec">{{ '%.2f'|format(metrics.motion_detection_stats.avg) }}s</span>{% else %}—{% endif %}</td>
                <td>{% if metrics.full_processing_stats %}<span class="sec">{{ '%.2f'|format(metrics.full_processing_stats.avg) }}s</span>{% else %}—{% endif %}</td>
              </tr>
              <tr>
                <td>max</td>
                <td>{% if metrics.motion_detection_stats %}<span class="sec">{{ '%.2f'|format(metrics.motion_detection_stats.max) }}s</span>{% else %}—{% endif %}</td>
                <td>{% if metrics.full_processing_stats %}<span class="sec">{{ '%.2f'|format(metrics.full_processing_stats.max) }}s</span>{% else %}—{% endif %}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Processing Times Chart</h2>
      {% if chart_pairs and chart_pairs|length > 0 %}
        {% set pairs = chart_pairs %}
        {% set cap = 300.0 %}
        {% set n = pairs|length %}
        {# Aggregate capped stats: max/min/avg computed over capped values #}
        {% set ns = namespace(maxv=0.0, minv=None, sumv=0.0) %}
        {% for p in pairs %}
          {% set v = p[1] %}
          {% set vc = (cap if v > cap else v) %}
          {% if ns.minv is none or vc < ns.minv %}{% set ns.minv = vc %}{% endif %}
          {% if vc > ns.maxv %}{% set ns.maxv = vc %}{% endif %}
          {% set ns.sumv = ns.sumv + vc %}
        {% endfor %}
        {% set maxv = ns.maxv %}
        {% set minv = (ns.minv if ns.minv is not none else 0.0) %}
        {% set avgv = (ns.sumv / n) %}
        <!-- Normalize to a fixed viewBox and space bars across full width -->
        {% set vbw = 1000 %}
        {% set vbh = 240 %}
        {% set left = 60 %}
        {% set right = 20 %}
        {% set topPad = 2 %}
        {% set bottomPad = 6 %}
        {% set yTop = topPad %}
        {% set yBottom = vbh - bottomPad %}
        {% set plotH = yBottom - yTop %}
        {% set axisW = vbw - left - right %}
        {% set step = axisW / n %}
        {% set barW = (step * 0.6) if step * 0.6 < 40 else 40 %}
        {% set denom = maxv if maxv > 0 else 1 %}
        {% set y_max = yBottom - (maxv / denom) * plotH %}
        {% set y_avg = yBottom - (avgv / denom) * plotH %}
        {% set y_min = yBottom - (minv / denom) * plotH %}
        <div class="chart-wrap">
          <svg class="chart" width="100%" height="260" viewBox="0 0 {{ vbw }} {{ vbh }}" preserveAspectRatio="xMinYMin meet">
            <!-- Axis -->
            <line x1="{{ left }}" y1="{{ yBottom }}" x2="{{ vbw - right }}" y2="{{ yBottom }}" stroke="#444" />
            <line x1="{{ left }}" y1="{{ yTop }}" x2="{{ left }}" y2="{{ yBottom }}" stroke="#444" />
            <!-- Grid lines for max/avg/min -->
            <line x1="{{ left }}" y1="{{ y_max }}" x2="{{ vbw - right }}" y2="{{ y_max }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_avg }}" x2="{{ vbw - right }}" y2="{{ y_avg }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_min }}" x2="{{ vbw - right }}" y2="{{ y_min }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <!-- Bars evenly spaced across full width -->
            {% for i in range(n) %}
              {% set vid = pairs[i][0] %}
              {% set val = pairs[i][1] %}
              {% set t = metrics.first_seen_ts_per_video.get(vid) %}
              {% set hour = t.strftime('%H') if t else None %}
              {% set st = metrics.status_per_video.get(vid, 'unknown') %}
              {% set col = status_colors.get(st, '#3b82f6') %}
              {% set x = left + i * step + (step - barW) / 2 %}
              {% set valc = (cap if val > cap else val) %}
              {% set h = (valc / denom) * plotH %}
              {% set y = yBottom - h %}
              <a href="#log-{{ vid }}">
                <rect x="{{ x }}" y="{{ y }}" width="{{ barW }}" height="{{ h }}" fill="{{ col }}">
                  {% if val > cap %}
                    <title>{{ vid }} ({{ '%.2f'|format(val) }}s, capped {{ '%.0f'|format(cap) }}s)</title>
                  {% else %}
                    <title>{{ vid }} ({{ '%.2f'|format(val) }}s)</title>
                  {% endif %}
                </rect>
              </a>
              <line x1="{{ left + i * step + step / 2 }}" y1="{{ yBottom }}" x2="{{ left + i * step + step / 2 }}" y2="{{ yBottom + 4 }}" stroke="#444" />
              {% if not loop.last %}
                {% set next_vid = pairs[i + 1][0] %}
                {% set t_next = metrics.first_seen_ts_per_video.get(next_vid) %}
                {% set next_hour = t_next.strftime('%H') if t_next else None %}
                {% if hour is not none and next_hour is not none and next_hour != hour %}
                  <!-- Hour boundary line (between bars i and i+1) -->
                  {% set x_sep = left + (i + 1) * step %}
                  <line x1="{{ x_sep }}" y1="{{ yTop }}" x2="{{ x_sep }}" y2="{{ yBottom }}" stroke="#2a2f40" stroke-dasharray="4,4" />
                  <!-- Hour label -->
                  <text class="axis-label" x="{{ x_sep }}" y="{{ yTop + 12 }}" text-anchor="middle" fill="#a8adc0">{{ next_hour|int }}h</text>
                {% endif %}
              {% endif %}
            {% endfor %}
            <!-- Y labels (right-aligned to the Y axis, numeric only) -->
            <text class="axis-label" x="{{ left - 8 }}" y="{{ yBottom }}" text-anchor="end" fill="#a8adc0">0</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_max + 12 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(maxv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_avg + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(avgv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_min + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(minv) }}</text>
          </svg>
        </div>
        {% if statuses_present and statuses_present|length > 0 %}
        <div class="chart-legend">
          <ul>
            {% for s in statuses_present %}
              {% set col = status_colors.get(s, '#3b82f6') %}
              {% set active = has_status and (s in status_list) %}
              {% set qs = '' %}
              {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
              {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
              {% if video %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'video=' ~ video %}{% endif %}
              {% set new_list = [] %}
              {% if active %}
                {% for t in status_list %}{% if t != s %}{% set _ = new_list.append(t) %}{% endif %}{% endfor %}
              {% else %}
                {% for t in status_list %}{% set _ = new_list.append(t) %}{% endfor %}
                {% set _ = new_list.append(s) %}
              {% endif %}
              {% if new_list and (new_list|length > 0) %}
                {% set status_csv = new_list|join(',') %}
                {% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}
              {% endif %}
              <li class="legend-item">
                <a class="link-log" href="{{ base }}{% if qs %}?{{ qs }}{% endif %}" title="{% if active %}Remove {{ s }}{% else %}Add {{ s }} filter{% endif %}">
                  <span class="legend-chip" style="background: {{ col }}"></span> {{ s }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      {% else %}
        <p>No processing time data.</p>
      {% endif %}
    </section>

    <details class="card" id="summary-card">
      <summary>Per-Video Summary</summary>
      {% if metrics.status_per_video %}
        <div class="table-wrap">
        <table class="table summary-table">
          <thead>
            <tr>
              <th class="start-col">Start</th>
              <th>Video</th>
              <th class="status-col">Status</th>
              <th class="time-events-col">Time / Events</th>
            </tr>
          </thead>
          <tbody>
            {% set status_filter = status %}
            {% for vid, st in metrics.status_per_video.items() %}
            <tr class="{% if play == vid %}playing{% endif %}">
              <td class="start-col">
                {% set t = metrics.first_seen_ts_per_video.get(vid) %}
                {% if t %}
                  <a href="#log-{{ vid }}" class="link-log">{{ t.strftime('%H:%M:%S') }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="status-col">
                {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
                {# Build query with existing filters, keeping multi-status selections #}
                {% set qs = 'play=' ~ vid %}
                {% if severity %}{% set qs = qs ~ '&severity=' ~ severity %}{% endif %}
                {% if status_list and (status_list|length > 0) %}
                  {% set status_csv = status_list|join(',') %}
                  {% set qs = qs ~ '&status=' ~ status_csv %}
                {% endif %}
                {% if gate %}{% set qs = qs ~ '&gate=' ~ gate %}{% endif %}
                <a href="{{ base }}?{{ qs }}" class="link-log" title="Open video player" data-vid="{{ vid }}" data-stream="/video/{{ vid }}" data-base="{{ base }}" data-query="{{ qs }}">
                  <span class="label-desktop">{{ vid }}</span>
                  <span class="label-mobile">{{ vid.split('_')[0] }}</span>
                </a>
              </td>
              {% set col = status_colors.get(st, '#3b82f6') %}
              {% set tcol = status_text_colors.get(st, '#ffffff') %}
              <td>
                <span class="tag status-chip" style="background: {{ col }}; color: {{ tcol }}" aria-label="{{ st }}" title="{{ st }}">
                  {{ st }}
                  {% set gdir = metrics.gate_direction_per_video.get(vid) %}
                  {% if gdir %}
                    {% set arrow = '↕' if gdir == 'both' else ('↑' if gdir == 'up' else '↓') %}
                    <span class="arrow-mobile" aria-hidden="true">{{ arrow }}</span>
                  {% endif %}
                </span>
                {% if gdir %}
                  <span class="tag gate-chip" title="Gate: {{ gdir }}" aria-label="Gate: {{ gdir }}">{{ arrow }}</span>
                {% endif %}
                {# ReID chips row #}
                {% set rscore = metrics.reid_best_score_per_video.get(vid) %}
                {% set rmatch = metrics.reid_matched_per_video.get(vid) %}
                {% set rneg = metrics.reid_neg_score_per_video.get(vid) %}
                {% if (rscore is not none and rmatch is not none) or (rneg is not none) %}
                <div class="chip-row reid-row">
                  {% if (rscore is not none) and (rmatch is not none) %}
                    {% set rkey = 'true' if rmatch else 'false' %}
                    {% set rcol = reid_colors.get(rkey, '#3b82f6') %}
                    {% set rtcol = reid_text_colors.get(rkey, '#ffffff') %}
                    <span class="tag aux-chip" style="background: {{ rcol }}; color: {{ rtcol }}" title="ReID score">{{ '%.0f'|format(rscore * 100.0) }}%</span>
                  {% endif %}
                  {% if rneg is not none %}
                    <span class="tag aux-chip" style="background: {{ neg_chip_color }}; color: {{ neg_chip_text_color }}" title="ReID neg">{{ '%.0f'|format(rneg * 100.0) }}%</span>
                  {% endif %}
                </div>
                {% endif %}
                {# Away/Back chips row #}
                {% if (metrics.away_videos and (vid in metrics.away_videos)) or (metrics.back_videos and (vid in metrics.back_videos)) %}
                <div class="chip-row state-row">
                  {% if metrics.away_videos and (vid in metrics.away_videos) %}
                    <span class="tag aux-chip" title="Away reaction">away</span>
                  {% endif %}
                  {% if metrics.back_videos and (vid in metrics.back_videos) %}
                    <span class="tag aux-chip" title="Back reaction">back</span>
                  {% endif %}
                </div>
                {% endif %}
              </td>
              <td class="time-events-col">
                {% set p = metrics.processing_time_per_video.get(vid) %}
                {% set events = metrics.raw_events_per_video.get(vid, 0) %}
                {% if events and (events > 0) %}
                  {% if p %}
                    <span class="label-desktop">{{ '%.2f'|format(p) }} <span class="sep">/</span> {{ events }}</span>
                    <span class="label-mobile">{{ '%.2f'|format(p) }}<span class="sep">/</span>{{ events }}</span>
                  {% else %}
                    <span class="label-desktop">— <span class="sep">/</span> {{ events }}</span>
                    <span class="label-mobile">—<span class="sep">/</span>{{ events }}</span>
                  {% endif %}
                {% else %}
                  {% if p %}
                    {{ '%.2f'|format(p) }}
                  {% else %}
                    —
                  {% endif %}
                {% endif %}
              </td>
            </tr>
            {% if play == vid and video_src %}
            <tr class="player-row">
              <td colspan="4">
                <div id="player" class="inline-player">
                  <div class="video-wrap">
                    <video class="video-embed" controls preload="metadata" src="{{ video_src }}">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <p>No video summaries.</p>
      {% endif %}
    </details>

    <details class="card" id="logs-card">
      <summary>Log Entries{% if severity %} ({{ severity }}){% endif %}</summary>
      {% if entries %}
        {% set ns = namespace(seen={}) %}
        <ul class="logs">
          {% for e in entries %}
          <li class="log {{ e.level|lower }}"{% if e.video and not ns.seen.get(e.video) %} id="log-{{ e.video }}"{% set _ = ns.seen.update({e.video: True}) %}{% endif %}>
            <div class="meta">
              <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
              <span class="lvl">{{ e.level }}</span>
              {% if e.video %}
                {% set vc = video_colors.get(e.video, '#9fb0ff') %}
                {% set parts = e.video.split('.') %}
                {% set vbase = parts[:-1] | join('.') %}
                {% set qs = '' %}
                {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
                {% if status_list and (status_list|length > 0) %}{% set status_csv = status_list|join(',') %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}{% endif %}
                {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
                <a class="video video-inline link-log" style="color: {{ vc }}" href="{{ base }}?video={{ e.video }}{% if qs %}&{{ qs }}{% endif %}" title="Filter by this video">{{ vbase }}</a>
              {% endif %}
            </div>
            <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
            <span class="lvl">{{ e.level }}</span>
            {% if e.video %}
              {% set vc = video_colors.get(e.video, '#9fb0ff') %}
              {% set qs = '' %}
              {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
              {% if status_list and (status_list|length > 0) %}{% set status_csv = status_list|join(',') %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}{% endif %}
              {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
              <div class="video"><a class="link-log" style="color: {{ vc }}" href="{{ base }}?video={{ e.video }}{% if qs %}&{{ qs }}{% endif %}" title="Filter by this video">{{ e.video }}</a></div>
            {% else %}
              <div class="video none">—</div>
            {% endif %}
            <div class="msg">{{ e.content }}</div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No entries for this day and filter.</p>
      {% endif %}
    </details>
  </main>
  <!-- Target anchor for jump-to-end -->
  <div id="page-bottom"></div>
  <script>
    (function(){
      function getOpenState(){
        try{
          var raw = localStorage.getItem('logdash-open');
          return raw ? JSON.parse(raw) : {};
        }catch(e){ return {}; }
      }
      function saveOpenState(state){
        try{ localStorage.setItem('logdash-open', JSON.stringify(state || {})); }catch(e){}
      }
      function restoreOpenState(){
        try{
          var state = getOpenState();
          var els = document.querySelectorAll('details[id]');
          els.forEach(function(d){
            var id = d.id;
            if(Object.prototype.hasOwnProperty.call(state, id)){
              d.open = !!state[id];
            }
            d.addEventListener('toggle', function(){
              var s = getOpenState();
              s[id] = d.open;
              saveOpenState(s);
            });
          });
        }catch(e){ /* noop */ }
      }
      function ensureLogsOpenIfHash(){
        try{
          var h = window.location.hash || '';
          if(h.startsWith('#log-')){
            var d = document.getElementById('logs-card');
            if(d && !d.open){ d.open = true; }
          }
        }catch(e){ /* noop */ }
      }
      function ensureLogsOpenIfVideo(){
        try{
          var params = new URLSearchParams(window.location.search);
          var video = params.get('video');
          if(video){
            var d = document.getElementById('logs-card');
            if(d && !d.open){ d.open = true; }
          }
        }catch(e){ /* noop */ }
      }
      function attachNavClears(){
        try{
          var links = document.querySelectorAll('header nav a[title="Home"], header nav a[title="All Days"]');
          if(links && links.length){
            links.forEach(function(a){
              a.addEventListener('click', function(){
                try{ localStorage.removeItem('logdash-open'); }catch(e){}
              });
            });
          }
        }catch(e){ /* noop */ }
      }
      function attachInlinePlayerLinks(){
        try{
          var table = document.querySelector('#summary-card table');
          if(!table){ return; }
          table.addEventListener('click', function(ev){
            var a = ev.target && ev.target.closest('a.link-log[title="Open video player"]');
            if(!a){ return; }
            ev.preventDefault();
            var vid = a.getAttribute('data-vid');
            var src = a.getAttribute('data-stream') || ('/video/' + vid);
            var base = a.getAttribute('data-base') || window.location.pathname;
            var qs = a.getAttribute('data-query') || ('play=' + encodeURIComponent(vid));
            // Update URL without reload
            try{ history.pushState(null, '', base + '?' + qs); }catch(e){}
            // Ensure summary is open
            var s = document.getElementById('summary-card');
            if(s && !s.open){ s.open = true; }
            // Mark playing row
            var row = a.closest('tr');
            document.querySelectorAll('tr.playing').forEach(function(r){ r.classList.remove('playing'); });
            if(row){ row.classList.add('playing'); }
            // Remove existing inline player row
            var existing = document.querySelector('tr.player-row');
            if(existing){ existing.parentNode.removeChild(existing); }
            // Insert new inline player row after clicked row
            if(row){
              var tr = document.createElement('tr');
              tr.className = 'player-row';
              var td = document.createElement('td');
              td.colSpan = 5;
              td.innerHTML = '<div id="player" class="inline-player"><div class="video-wrap"><video class="video-embed" controls preload="metadata" src="' + src + '">Your browser does not support the video tag.</video></div></div>';
              tr.appendChild(td);
              row.parentNode.insertBefore(tr, row.nextSibling);
              // Scroll so exactly one row is visible above the player, accounting for header
              var prev = tr.previousElementSibling;
              var topElem = (prev && prev.tagName && prev.tagName.toLowerCase() === 'tr') ? prev : tr;
              var header = document.querySelector('header');
              var headerH = header ? (header.offsetHeight || 0) : 0;
              var pad = 6;
              var rect = topElem.getBoundingClientRect();
              var y = window.scrollY + rect.top - headerH - pad;
              try{ window.scrollTo({ top: y, behavior: 'smooth' }); }
              catch(e){ window.scrollTo(0, y); }
            }
          });
        }catch(e){ /* noop */ }
      }
      function focusInlinePlayerIfPresent(){
        try{
          var params = new URLSearchParams(window.location.search);
          var play = params.get('play');
          if(!play){ return; }
          // Ensure summary is open (in case persisted state had it closed)
          var s = document.getElementById('summary-card');
          if(s && !s.open){ s.open = true; }
          // After DOM paints, scroll to inline player or playing row (center aligned)
          setTimeout(function(){
            try{
              var playerRow = document.querySelector('tr.player-row');
              var header = document.querySelector('header');
              var headerH = header ? (header.offsetHeight || 0) : 0;
              var pad = 6; // small breathing room under header
              if(playerRow){
                var prev = playerRow.previousElementSibling;
                var topElem = (prev && prev.tagName && prev.tagName.toLowerCase() === 'tr') ? prev : playerRow;
                var rect = topElem.getBoundingClientRect();
                var y = window.scrollY + rect.top - headerH - pad;
                try{ window.scrollTo({ top: y, behavior: 'smooth' }); }
                catch(e){ window.scrollTo(0, y); }
              } else {
                // Fallback: align playing row similarly
                var row = document.querySelector('tr.playing');
                if(row){
                  var rPrev = row.previousElementSibling;
                  var rTopElem = (rPrev && rPrev.tagName && rPrev.tagName.toLowerCase() === 'tr') ? rPrev : row;
                  var rRect = rTopElem.getBoundingClientRect();
                  var ry = window.scrollY + rRect.top - headerH - pad;
                  try{ window.scrollTo({ top: ry, behavior: 'smooth' }); }
                  catch(e){ window.scrollTo(0, ry); }
                }
              }
            }catch(e){ /* noop */ }
          }, 50);
        }catch(e){ /* noop */ }
      }
      function focusVideoLogsIfSelected(){
        try{
          var params = new URLSearchParams(window.location.search);
          var video = params.get('video');
          if(!video){ return; }
          setTimeout(function(){
            try{
              var target = document.getElementById('log-' + video);
              var header = document.querySelector('header');
              var headerH = header ? (header.offsetHeight || 0) : 0;
              var pad = 6;
              if(target){
                var rect = target.getBoundingClientRect();
                var y = window.scrollY + rect.top - headerH - pad;
                try{ window.scrollTo({ top: y, behavior: 'smooth' }); }
                catch(e){ window.scrollTo(0, y); }
              }
            }catch(e){ /* noop */ }
          }, 50);
        }catch(e){ /* noop */ }
      }
      // First restore user's previous open/closed state
      restoreOpenState();
      // Then apply forced openings based on hash or query
      ensureLogsOpenIfHash();
      ensureLogsOpenIfVideo();
      // Finally, focus the inline player (or playing row) if present
      focusInlinePlayerIfPresent();
      // If filtering by video, scroll to its first log entry
      focusVideoLogsIfSelected();
      // Enable inline player behavior without full page reload
      attachInlinePlayerLinks();
      // Clear persisted state when navigating Home or All Days
      attachNavClears();
      // Ensure scroll-up button works even if hash doesn't change
      (function(){
        try{
          var up = document.querySelector('.fab-top');
          if(up){
            up.addEventListener('click', function(ev){
              ev.preventDefault();
              try{ window.scrollTo({ top: 0, behavior: 'smooth' }); }
              catch(e){ window.scrollTo(0, 0); }
            });
          }
        }catch(e){ /* noop */ }
      })();
      // Toggle floating buttons visibility based on scroll position (hide at top)
      function toggleFabs(){
        try{
          var y = window.scrollY || document.documentElement.scrollTop || 0;
          var atTop = y <= 2;
          var down = document.querySelector('.fab');
          var up = document.querySelector('.fab-top');
          if(down){ down.classList.toggle('hidden', atTop); }
          if(up){ up.classList.toggle('hidden', atTop); }
        }catch(e){ /* noop */ }
      }
      // Initial state and listeners
      toggleFabs();
      window.addEventListener('scroll', toggleFabs, { passive: true });
      window.addEventListener('resize', toggleFabs);
      window.addEventListener('hashchange', ensureLogsOpenIfHash);
    })();
  </script>
</body>
</html>