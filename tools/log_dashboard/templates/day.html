<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logs for {{ day }}</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header id="page-top">
    <div class="inner">
      <h1>{{ day }}</h1>
      <nav>
        <a class="nav-btn" href="{% if is_today_route %}/today{% else %}/day/{{ day }}{% endif %}" title="Home">Home</a>
        <a class="nav-btn" href="/" title="All Days">All Days</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- Floating action buttons (mobile): jump to end / top -->
    <a href="#page-bottom" class="fab" aria-label="Jump to end">↓</a>
    <a href="#page-top" class="fab-top" aria-label="Back to top">↑</a>
    {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
    <section class="controls">
      <div class="filters">
        <span class="muted">Severity:</span>
        <div class="badge-row">
          {% for lvl in levels %}
            {% set scol = severity_colors.get(lvl, '#3b82f6') %}
            {% set stcol = severity_text_colors.get(lvl, '#ffffff') %}
            {% set status_csv = status_list|join(',') if status_list and (status_list|length > 0) else '' %}
            <a class="link-log" href="{% if severity == lvl %}{{ base }}{% if status_csv %}?status={{ status_csv }}{% endif %}{% else %}{{ base }}?severity={{ lvl }}{% if status_csv %}&status={{ status_csv }}{% endif %}{% endif %}" title="{% if severity == lvl %}Clear severity filter{% else %}Filter by {{ lvl }}{% endif %}">
              <span class="tag {% if severity == lvl %}active{% endif %}" style="background: {{ scol }}; color: {{ stcol }}">{{ lvl }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Status Counts</h2>
        {# Ensure we have a list from backend-provided status_list #}
        {% set status_list = status_list or [] %}
        {% set has_status = status_list and (status_list|length > 0) %}
        {% if severity or has_status or gate %}
          <p class="muted">
            Filtered videos: <strong>{{ metrics.videos_total }}</strong>
            (Total today: <strong>{{ total_videos_all }}</strong>)
            {# Clear all filters when any filter is selected #}
            {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
            <a class="link-log" href="{{ base }}" title="Clear all filters">
              <span class="tag">Clear</span>
            </a>
          </p>
        {% else %}
          <p class="muted">Total videos: <strong>{{ total_videos_all }}</strong></p>
        {% endif %}
        {% if statuses and statuses|length > 0 %}
          {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
          <ul class="stats status-badges">
            {% for k in statuses %}
              {% set v = status_counts_all.get(k, 0) %}
              {% set col = status_colors.get(k, '#3b82f6') %}
              {% set tcol = status_text_colors.get(k, '#ffffff') %}
              <li>
                {% set active = has_status and (k in status_list) %}
                {% set qs = '' %}
                {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
                {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
                {% set new_list = [] %}
                {% if active %}
                  {% for s in status_list %}{% if s != k %}{% set _ = new_list.append(s) %}{% endif %}{% endfor %}
                {% else %}
                  {% for s in status_list %}{% set _ = new_list.append(s) %}{% endfor %}
                  {% set _ = new_list.append(k) %}
                {% endif %}
                {% if new_list and (new_list|length > 0) %}
                  {% set status_csv = new_list|join(',') %}
                  {% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}
                {% endif %}
                <a class="link-log" href="{{ base }}{% if qs %}?{{ qs }}{% endif %}" title="{% if active %}Remove {{ k }}{% else %}Add {{ k }} filter{% endif %}">
                  <span class="tag {% if active %}active{% endif %}" style="background: {{ col }}; color: {{ tcol }}">{{ k }}</span>
                </a>
                <strong>{{ v }}</strong>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No status entries.</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>Gate Crossings</h2>
        {% set status_csv = status_list|join(',') if status_list and (status_list|length > 0) else '' %}
        <ul class="stats">
          <li>
            <a class="link-log" href="{% if gate == 'up' %}{{ base }}{% if severity or status_csv %}?{% endif %}{% if severity %}severity={{ severity }}{% endif %}{% if status_csv %}{% if severity %}&{% endif %}status={{ status_csv }}{% endif %}{% else %}{{ base }}?gate=up{% if severity %}&severity={{ severity }}{% endif %}{% if status_csv %}&status={{ status_csv }}{% endif %}{% endif %}" title="{% if gate == 'up' %}Clear gate filter{% else %}Filter by gate: up{% endif %}">
              <span class="tag {% if gate == 'up' %}active{% endif %}">up</span>
            </a>
            <strong>{{ metrics.gate_counts.up }}</strong>
          </li>
          <li>
            <a class="link-log" href="{% if gate == 'down' %}{{ base }}{% if severity or status_csv %}?{% endif %}{% if severity %}severity={{ severity }}{% endif %}{% if status_csv %}{% if severity %}&{% endif %}status={{ status_csv }}{% endif %}{% else %}{{ base }}?gate=down{% if severity %}&severity={{ severity }}{% endif %}{% if status_csv %}&status={{ status_csv }}{% endif %}{% endif %}" title="{% if gate == 'down' %}Clear gate filter{% else %}Filter by gate: down{% endif %}">
              <span class="tag {% if gate == 'down' %}active{% endif %}">down</span>
            </a>
            <strong>{{ metrics.gate_counts.down }}</strong>
          </li>
        </ul>
      </div>

      <div class="card">
        <h2>Full Processing Time</h2>
        {% if metrics.full_processing_stats %}
          <ul class="stats">
            <li>min: <strong>{{ '%.2f'|format(metrics.full_processing_stats.min) }}s</strong></li>
            <li>avg: <strong>{{ '%.2f'|format(metrics.full_processing_stats.avg) }}s</strong></li>
            <li>max: <strong>{{ '%.2f'|format(metrics.full_processing_stats.max) }}s</strong></li>
          </ul>
        {% else %}
          <p>No full processing timings.</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>Motion Detection Time</h2>
        {% if metrics.motion_detection_stats %}
          <ul class="stats">
            <li>min: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.min) }}s</strong></li>
            <li>avg: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.avg) }}s</strong></li>
            <li>max: <strong>{{ '%.2f'|format(metrics.motion_detection_stats.max) }}s</strong></li>
          </ul>
        {% else %}
          <p>No motion detection timing entries.</p>
        {% endif %}
      </div>
    </section>

    <details class="card" id="summary-card">
      <summary>Per-Video Summary</summary>
      {% if metrics.status_per_video %}
        <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Start</th>
              <th>Video</th>
              <th>Status</th>
              <th>Raw Events</th>
              <th>Processing Time</th>
            </tr>
          </thead>
          <tbody>
            {% set status_filter = status %}
            {% for vid, st in metrics.status_per_video.items() %}
            <tr class="{% if play == vid %}playing{% endif %}">
              <td>
                {% set t = metrics.first_seen_ts_per_video.get(vid) %}
                {% if t %}
                  <a href="#log-{{ vid }}" class="link-log">{{ t.strftime('%H:%M:%S') }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if is_today_route %}{% set base = '/today' %}{% else %}{% set base = '/day/' ~ day %}{% endif %}
                {# Build query with existing filters, keeping multi-status selections #}
                {% set qs = 'play=' ~ vid %}
                {% if severity %}{% set qs = qs ~ '&severity=' ~ severity %}{% endif %}
                {% if status_list and (status_list|length > 0) %}
                  {% set status_csv = status_list|join(',') %}
                  {% set qs = qs ~ '&status=' ~ status_csv %}
                {% endif %}
                {% if gate %}{% set qs = qs ~ '&gate=' ~ gate %}{% endif %}
                <a href="{{ base }}?{{ qs }}#player" class="link-log" title="Open video player">{{ vid }}</a>
              </td>
              {% set col = status_colors.get(st, '#3b82f6') %}
              {% set tcol = status_text_colors.get(st, '#ffffff') %}
              <td>
                <span class="tag status-chip" style="background: {{ col }}; color: {{ tcol }}" aria-label="{{ st }}" title="{{ st }}">
                  {{ st }}
                  {% set gdir = metrics.gate_direction_per_video.get(vid) %}
                  {% if gdir %}
                    {% set arrow = '↕' if gdir == 'both' else ('↑' if gdir == 'up' else '↓') %}
                    <span class="arrow-mobile" aria-hidden="true">{{ arrow }}</span>
                  {% endif %}
                </span>
                {% if gdir %}
                  <span class="tag gate-chip" title="Gate: {{ gdir }}" aria-label="Gate: {{ gdir }}">{{ arrow }}</span>
                {% endif %}
              </td>
              <td>{{ metrics.raw_events_per_video.get(vid, 0) }}</td>
              <td>
                {% set p = metrics.processing_time_per_video.get(vid) %}
                {% if p %}
                  {{ '%.2f'|format(p) }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <p>No video summaries.</p>
      {% endif %}
    </details>

    {% if video_src %}
    <section class="card" id="player">
      <h2>Video Player{% if play %} — {{ play }}{% endif %}</h2>
      <div class="video-wrap">
        <video class="video-embed" controls preload="metadata" src="{{ video_src }}">
          Your browser does not support the video tag.
        </video>
      </div>
    </section>
    {% endif %}

    <section class="card">
      <h2>Processing Times Chart</h2>
      {% if chart_pairs and chart_pairs|length > 0 %}
        {% set pairs = chart_pairs %}
        {% set values = pairs|map(attribute=1)|list %}
        {% set maxv = (values|max) %}
        {% set minv = (values|min) %}
        {% set avgv = (values|sum / values|length) %}
        {% set n = pairs|length %}
        <!-- Normalize to a fixed viewBox and space bars across full width -->
        {% set vbw = 1000 %}
        {% set vbh = 240 %}
        {% set left = 60 %}
        {% set right = 20 %}
        {% set topPad = 2 %}
        {% set bottomPad = 6 %}
        {% set yTop = topPad %}
        {% set yBottom = vbh - bottomPad %}
        {% set plotH = yBottom - yTop %}
        {% set axisW = vbw - left - right %}
        {% set step = axisW / n %}
        {% set barW = (step * 0.6) if step * 0.6 < 40 else 40 %}
        {% set denom = maxv if maxv > 0 else 1 %}
        {% set y_max = yBottom - (maxv / denom) * plotH %}
        {% set y_avg = yBottom - (avgv / denom) * plotH %}
        {% set y_min = yBottom - (minv / denom) * plotH %}
        <div class="chart-wrap">
          <svg class="chart" width="100%" height="260" viewBox="0 0 {{ vbw }} {{ vbh }}" preserveAspectRatio="xMinYMin meet">
            <!-- Axis -->
            <line x1="{{ left }}" y1="{{ yBottom }}" x2="{{ vbw - right }}" y2="{{ yBottom }}" stroke="#444" />
            <line x1="{{ left }}" y1="{{ yTop }}" x2="{{ left }}" y2="{{ yBottom }}" stroke="#444" />
            <!-- Grid lines for max/avg/min -->
            <line x1="{{ left }}" y1="{{ y_max }}" x2="{{ vbw - right }}" y2="{{ y_max }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_avg }}" x2="{{ vbw - right }}" y2="{{ y_avg }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <line x1="{{ left }}" y1="{{ y_min }}" x2="{{ vbw - right }}" y2="{{ y_min }}" stroke="#2a2f40" stroke-dasharray="3,3" />
            <!-- Bars evenly spaced across full width -->
            {% for i in range(n) %}
              {% set vid = pairs[i][0] %}
              {% set val = pairs[i][1] %}
              {% set st = metrics.status_per_video.get(vid, 'unknown') %}
              {% set col = status_colors.get(st, '#3b82f6') %}
              {% set x = left + i * step + (step - barW) / 2 %}
              {% set h = (val / denom) * plotH %}
              {% set y = yBottom - h %}
              <a href="#log-{{ vid }}">
                <rect x="{{ x }}" y="{{ y }}" width="{{ barW }}" height="{{ h }}" fill="{{ col }}">
                  <title>{{ vid }} ({{ '%.2f'|format(val) }}s)</title>
                </rect>
              </a>
              <line x1="{{ left + i * step + step / 2 }}" y1="{{ yBottom }}" x2="{{ left + i * step + step / 2 }}" y2="{{ yBottom + 4 }}" stroke="#444" />
            {% endfor %}
            <!-- Y labels (right-aligned to the Y axis, numeric only) -->
            <text class="axis-label" x="{{ left - 8 }}" y="{{ yBottom }}" text-anchor="end" fill="#a8adc0">0</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_max + 12 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(maxv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_avg + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(avgv) }}</text>
            <text class="axis-label" x="{{ left - 8 }}" y="{{ y_min + 4 }}" text-anchor="end" fill="#a8adc0">{{ '%.1f'|format(minv) }}</text>
          </svg>
        </div>
        {% if statuses_present and statuses_present|length > 0 %}
        <div class="chart-legend">
          <ul>
            {% for s in statuses_present %}
              {% set col = status_colors.get(s, '#3b82f6') %}
              {% set active = has_status and (s in status_list) %}
              {% set qs = '' %}
              {% if severity %}{% set qs = qs ~ 'severity=' ~ severity %}{% endif %}
              {% if gate %}{% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'gate=' ~ gate %}{% endif %}
              {% set new_list = [] %}
              {% if active %}
                {% for t in status_list %}{% if t != s %}{% set _ = new_list.append(t) %}{% endif %}{% endfor %}
              {% else %}
                {% for t in status_list %}{% set _ = new_list.append(t) %}{% endfor %}
                {% set _ = new_list.append(s) %}
              {% endif %}
              {% if new_list and (new_list|length > 0) %}
                {% set status_csv = new_list|join(',') %}
                {% if qs %}{% set qs = qs ~ '&' %}{% endif %}{% set qs = qs ~ 'status=' ~ status_csv %}
              {% endif %}
              <li class="legend-item">
                <a class="link-log" href="{{ base }}{% if qs %}?{{ qs }}{% endif %}" title="{% if active %}Remove {{ s }}{% else %}Add {{ s }} filter{% endif %}">
                  <span class="legend-chip" style="background: {{ col }}"></span> {{ s }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      {% else %}
        <p>No processing time data.</p>
      {% endif %}
    </section>

    <details class="card" id="logs-card">
      <summary>Log Entries{% if severity %} ({{ severity }}){% endif %}</summary>
      {% if entries %}
        {% set ns = namespace(seen={}) %}
        <ul class="logs">
          {% for e in entries %}
          <li class="log {{ e.level|lower }}"{% if e.video and not ns.seen.get(e.video) %} id="log-{{ e.video }}"{% set _ = ns.seen.update({e.video: True}) %}{% endif %}>
            <div class="meta">
              <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
              <span class="lvl">{{ e.level }}</span>
              {% if e.video %}
                {% set vc = video_colors.get(e.video, '#9fb0ff') %}
                {% set parts = e.video.split('.') %}
                {% set base = parts[:-1] | join('.') %}
                <span class="video video-inline" style="color: {{ vc }}">{{ base }}</span>
              {% endif %}
            </div>
            <span class="ts">{{ e.ts.strftime('%H:%M:%S') }}</span>
            <span class="lvl">{{ e.level }}</span>
            {% if e.video %}
              {% set vc = video_colors.get(e.video, '#9fb0ff') %}
              <div class="video" style="color: {{ vc }}">{{ e.video }}</div>
            {% else %}
              <div class="video none">—</div>
            {% endif %}
            <div class="msg">{{ e.content }}</div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No entries for this day and filter.</p>
      {% endif %}
    </details>
  </main>
  <!-- Target anchor for jump-to-end -->
  <div id="page-bottom"></div>
  <script>
    (function(){
      function getOpenState(){
        try{
          var raw = localStorage.getItem('logdash-open');
          return raw ? JSON.parse(raw) : {};
        }catch(e){ return {}; }
      }
      function saveOpenState(state){
        try{ localStorage.setItem('logdash-open', JSON.stringify(state || {})); }catch(e){}
      }
      function restoreOpenState(){
        try{
          var state = getOpenState();
          var els = document.querySelectorAll('details[id]');
          els.forEach(function(d){
            var id = d.id;
            if(Object.prototype.hasOwnProperty.call(state, id)){
              d.open = !!state[id];
            }
            d.addEventListener('toggle', function(){
              var s = getOpenState();
              s[id] = d.open;
              saveOpenState(s);
            });
          });
        }catch(e){ /* noop */ }
      }
      function ensureLogsOpenIfHash(){
        try{
          var h = window.location.hash || '';
          if(h.startsWith('#log-')){
            var d = document.getElementById('logs-card');
            if(d && !d.open){ d.open = true; }
          }
        }catch(e){ /* noop */ }
      }
      function ensureSummaryOpenIfPlaying(){
        try{
          var params = new URLSearchParams(window.location.search);
          var hasPlay = params.has('play');
          var h = window.location.hash || '';
          if(hasPlay || h === '#player'){
            var s = document.getElementById('summary-card');
            if(s && !s.open){ s.open = true; }
          }
        }catch(e){ /* noop */ }
      }
      function attachNavClears(){
        try{
          var links = document.querySelectorAll('header nav a[title="Home"], header nav a[title="All Days"]');
          if(links && links.length){
            links.forEach(function(a){
              a.addEventListener('click', function(){
                try{ localStorage.removeItem('logdash-open'); }catch(e){}
              });
            });
          }
        }catch(e){ /* noop */ }
      }
      // First restore user's previous open/closed state
      restoreOpenState();
      // Then apply forced openings based on hash or query
      ensureLogsOpenIfHash();
      ensureSummaryOpenIfPlaying();
      // Clear persisted state when navigating Home or All Days
      attachNavClears();
      // Ensure scroll-up button works even if hash doesn't change
      (function(){
        try{
          var up = document.querySelector('.fab-top');
          if(up){
            up.addEventListener('click', function(ev){
              ev.preventDefault();
              try{ window.scrollTo({ top: 0, behavior: 'smooth' }); }
              catch(e){ window.scrollTo(0, 0); }
            });
          }
        }catch(e){ /* noop */ }
      })();
      window.addEventListener('hashchange', ensureLogsOpenIfHash);
      window.addEventListener('popstate', ensureSummaryOpenIfPlaying);
    })();
  </script>
</body>
</html>